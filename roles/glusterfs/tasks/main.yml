---
- name: install glusterfs
  package: name={{ item }} state=present
  with_items:
    - glusterfs-api
    - glusterfs
    - glusterfs-cli
    - glusterfs-fuse
    - glusterfs-libs
    - centos-release-gluster
    - glusterfs-server
    - xfsprogs

- name: Ensure Gluster brick and mount directories exist
  file: "path={{ item }} state=directory mode=0776"
  with_items:
    - "{{ gluster_brick_dir }}"
    - "{{ gluster_mount_dir }}"

- name: Configure gluster volume
  gluster_volume:
    state: present
    name: "{{ gluster_brick_name }}"
    brick: "{{ gluster_brick_dir }}"
    replicas: 2
    cluster: "{{ groups.storage | join(',') }}"
    host: "{{ inventory_hostname }}"
    force: no
  run_once: true
  
- name: Ensure gluster volume is mounted
  mount: 
    name: "{{ gluster_mount_dir }}"
    src: "{{ groups.storage[0] }}:/{{ gluster_brick_name }}"
    fstype: glusterfs
    opts: "defaults,_netdev"
    state: mounted
