---

#- name: create directory for pgbouncer
  #file:
    #path: /pgbouncer-1.8.1
    #state: directory
    #mode: 0755
  
- name: download pgbouncer source
  unarchive:
    src: https://pgbouncer.github.io/downloads/files/1.8.1/pgbouncer-1.8.1.tar.gz
    dest: /
    remote_src: yes

- name: download devel packages
  package: name={{ item }} state=present
  with_items:
    - gcc
    - libevent-devel
    - openssl-devel
    
- name: configure the pgbouncer
  shell: ./configure --prefix=/usr
  args:
    chdir: /pgbouncer-1.8.1

- name: make 
  shell: make
  args:
    chdir: /pgbouncer-1.8.1
    
- name: make install
  shell: make install
  args:
    chdir: /pgbouncer-1.8.1

- name: create the log directory for pgbouncer
  file:
    path: /var/log/pgbouncer
    state: directory
    mode: 0755
    owner: postgres
    
- name: create the directory for service lock file
  file:
    path: /var/run/pgbouncer
    state: directory
    mode: 0755
    owner: postgres
    
- name: create the configuration directory
  file:
    path: /etc/pgbouncer
    state: directory
    mode: 0755
    owner: postgres
  
- name: copy over the pgbouncer.ini
  copy:
    remote_src: /pgbouncer-1.8.1/etc/pgbouncer.ini
    dest: /etc/pgbouncer/
    
- name: change the file permissions on pgbouncer.ini
  file:
    path: /etc/pgbouncer/pgbouncer.ini
    owner: postgres
    group: postgres
    mode: 0644
    
- name: copy the file over /etc/init.d/pgbouncer
  template:
    src: /home/ls1980/code/webapp/roles/PG_Bouncer/templates/pgbouncer
    dest: /etc/init.d/pgbouncer
    mode: a+x
    
- name: add the service to the system start up and shutdown
  shell: chkconfig --add pgbouncer
